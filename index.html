<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <title>we are open</title>
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/i18next/dist/umd/i18next.js"></script>
    <script src="https://openingh.openstreetmap.de/opening_hours.js/opening_hours+deps.min.js"></script>

    <style>
        body {
            margin: 0;
        }

        h1, h2, h3 {
            color: white;
        }

        h1 {
            font-size: 6rem;
            margin: 0;
        }

        h2 {
            font-size: 2rem;
        }

        #app {
            align-items: center;
            background: #fe5f55;
            display: flex;
            height: 100vh;
            justify-content: center;
            text-align: center;
            width: 100vw;
        }

        #app.open {
            background: #90be6d;
        }
    </style>
</head>
<body>
<div id="app" :class="isOpen ? 'open' : ''">
    <status v-bind:is-open="isOpen"
            v-bind:now="now"></status>
</div>
<script>

    // follows the OSM opening hours syntax specification
    // @link https://wiki.openstreetmap.org/wiki/Key:opening_hours/specification
    let openingHours = ''
        + 'Mo,Tu,Th,Fr 09:00-12:36,15:00-18:00,Sa 09:00-12:00;' // regular opening hours
        + 'PH closed;' // closed on public holidays
        + 'Dec 24-Feb Th[1] closed;' // closed in winter times from christmas until first thursday in february
        + 'Oct Mo[3] closed "Kirchweihmontag";' // church fair every third monday in october

    let countryCode = 'de';
    let locale = navigator.language;

    let validator = new opening_hours(
        openingHours,
        {
            'address': {
                'country_code': countryCode
            }
        }, {
            'locale': locale
        }
    );

    i18next.init({lng: 'en'});

    console.log(i18next.t('human'));

    Vue.component('status', {
        inject: ['validator'],
        props: {
            isOpen: Boolean,
            now: String
        },
        name: 'Status',
        template: `
            <div>
            <h1>{{ getState() }}</h1>
            <h2>{{ getNext() }}</h2>
            <h3>{{ getCurrent() }} Uhr</h3>
            </div>`,
        methods: {
            getCurrent() {
                return this.now;
            },
            getNext() {

                let date = this.validator.getNextChange();
                let time = date.toLocaleTimeString('de', {hour: '2-digit', minute: '2-digit'});

                let day = date.getDay();

                if (day === new Date().getDay()) {
                    day = 'heute';
                } else {
                    day = 'am ' + date.toLocaleDateString('de', {weekday: 'long'});
                }

                return (this.isOpen)
                    ? `Wir schließen ${day} um ${time} Uhr`
                    : `Wir öffnen wieder ${day} um ${time} Uhr`;
            },
            getState: function() {
                return (this.isOpen)
                    ? 'geöffnet'
                    : 'geschlossen';
            },
            getNextChange() {
                let date = this.validator.getNextChange();
                let options = {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'};

                return date.toLocaleDateString('de', options);
            }
        },
        watch: {
            now: function() {
                this.$forceUpdate();
            }
        }
    });

    let vm = new Vue({
        el: '#app',
        data: {
            isOpen: null,
            now: null,
            validator: validator
        },
        provide() {
            return {
                validator: this.validator
            }
        },
        mounted() {
            setInterval(() => {
                this.isOpen = this.validator.getState();
                this.now = new Date().toLocaleString('de');
            }, 1000);
        },
    });

</script>
</body>
</html>
